# Story 2.2: Create New Test Set

## Status
Done

## Story
**As a** Prompt Engineer,
**I want** to create and save a new Test Set with a name, description, and a list of categories,
**so that** I can define a new, reusable set of evaluation criteria.

## Acceptance Criteria
1. Clicking the "Create New Test Set" button navigates to a new page or opens a modal form.
2. The form includes text input fields for "Name" and "Description" for the Test Set.
3. The form includes a dynamic list editor where the user can define ground truth categories.
4. Each category entry in the list editor consists of a "Category Name" (e.g., "A++") and a "Description".
5. The user can dynamically add or remove category rows from the list.
6. Submitting the form saves the complete Test Set (name, description, and all categories) to the database.
7. After a successful save, the user is redirected to the Test Set list page, which now includes the newly created item.

## Tasks / Subtasks
- [x] Create Test Set creation page route (AC: 1)
  - [x] Create new page at `src/app/test-sets/new/page.tsx`
  - [x] Implement as client component to use forms and state
  - [x] Add loading and error states for form submission

- [x] Update Test Set service with create functions (AC: 6)
  - [x] Add `createTestSet()` function to `src/services/testSetService.ts`
  - [x] Add `createGroundTruthCategories()` function for batch category creation
  - [x] Implement proper error handling with try/catch blocks
  - [x] Use transaction to ensure atomic creation of test set and categories

- [x] Update Test Set store with create actions (AC: 6, 7)
  - [x] Add `createTestSet` action to `src/stores/useTestSetStore.ts`
  - [x] Handle optimistic updates if appropriate
  - [x] Add error state management for failed submissions

- [x] Create Test Set form component (AC: 2, 3, 4, 5)
  - [x] Create `src/components/features/test-sets/TestSetForm.tsx`
  - [x] Add form validation using react-hook-form or similar
  - [x] Implement Name input field (required)
  - [x] Implement Description textarea field (optional)
  - [x] Create dynamic category list editor subcomponent

- [x] Create dynamic category list editor component (AC: 3, 4, 5)
  - [x] Create `src/components/features/test-sets/CategoryListEditor.tsx`
  - [x] Implement category rows with Name and Description fields
  - [x] Add "Add Category" button to append new rows
  - [x] Add "Remove" button for each category row
  - [x] Ensure at least one category is required

- [x] Implement form submission and navigation (AC: 6, 7)
  - [x] Connect form to `createTestSet` store action
  - [x] Show loading state during submission
  - [x] Handle and display errors appropriately
  - [x] Use Next.js router to redirect to `/test-sets` on success
  - [x] Show success toast/notification

- [x] Update navigation from Test Set list page (AC: 1)
  - [x] Ensure "Create New Test Set" button links to `/test-sets/new`
  - [x] Verify button is prominent and accessible

- [x] Add unit tests for new components
  - [x] Test TestSetForm component with mocked service
  - [x] Test CategoryListEditor add/remove functionality
  - [x] Test form validation rules
  - [x] Test navigation after successful submission

## Dev Notes

### Previous Story Insights
[Source: Story 2.1 Dev Agent Record]
- Successfully implemented TestSet and GroundTruthCategory interfaces in shared package
- Established service layer pattern with proper error handling
- Zustand store implementation working well for state management
- All components follow Shadcn UI patterns consistently

### Data Models
[Source: architecture/data-models.md]
```typescript
export interface TestSet {
  id: string;
  name: string;
  description?: string;
  json_extraction_key?: string;
  categories?: GroundTruthCategory[];
}

export interface GroundTruthCategory {
  id: string;
  test_set_id: string;
  name: string;
  description: string;
}
```

### Database Schema
[Source: architecture/database-schema.md]
- Table: `public.test_sets`
  - Columns: id (UUID), user_id (UUID), created_at (TIMESTAMPTZ), name (TEXT), description (TEXT), json_extraction_key (TEXT)
- Table: `public.ground_truth_categories`
  - Columns: id (UUID), test_set_id (UUID), name (TEXT), description (TEXT)
  - Has foreign key relationship to test_sets table

### API Service Pattern
[Source: architecture/frontend-architecture.md#frontend-services-layer]
- Service functions must be in `src/services/testSetService.ts`
- Use `createClient()` from `@/utils/supabase/client`
- All API functions MUST include try/catch blocks
- Return appropriate error states for UI handling

Example pattern for create operation:
```typescript
export async function createTestSet(testSet: Omit<TestSet, 'id'>) {
  const supabase = createClient();
  const { data, error } = await supabase
    .from('test_sets')
    .insert(testSet)
    .select()
    .single();

  if (error) {
    console.error('Error creating test set:', error);
    throw error;
  }
  return data;
}
```

### State Management Pattern
[Source: architecture/frontend-architecture.md#state-management-architecture]
- Use existing Zustand store at `src/stores/useTestSetStore.ts`
- Add create actions following existing patterns
- Handle loading and error states appropriately

### Component Architecture
[Source: architecture/frontend-architecture.md#component-architecture]
- UI Components: `src/components/ui/` - Use existing Shadcn components
- Feature Components: `src/components/features/test-sets/` - Test Set specific components
- Follow component template pattern with TypeScript interfaces

### File Locations
[Source: architecture/unified-project-structure.md]
- Page Route: `apps/web/src/app/test-sets/new/page.tsx`
- Feature Components: `apps/web/src/components/features/test-sets/`
- Service Updates: `apps/web/src/services/testSetService.ts`
- Store Updates: `apps/web/src/stores/useTestSetStore.ts`

### Routing Architecture
[Source: architecture/frontend-architecture.md#routing-architecture]
- Use Next.js App Router
- Create new route at `src/app/test-sets/new/page.tsx`
- Use `useRouter` from `next/navigation` for programmatic navigation
- Route will be protected by existing middleware

### Form Libraries and Patterns
- Consider using react-hook-form for form state management
- Use Shadcn UI form components (Input, Textarea, Button)
- Implement client-side validation before submission
- Show appropriate loading states during async operations

### Coding Standards
[Source: architecture/coding-standards.md]
- Shared types already defined in packages/shared
- Frontend MUST NOT call Supabase directly - use service layer
- All API functions MUST include try/catch blocks
- Component naming: PascalCase (TestSetForm.tsx, CategoryListEditor.tsx)
- Database tables: snake_case (test_sets, ground_truth_categories)

### Testing Requirements
[Source: architecture/testing-strategy.md]
- Framework: Vitest with React Testing Library
- Test Location: Co-locate with components (e.g., TestSetForm.test.tsx)
- Mock Supabase client in tests
- Test user interactions: form submission, add/remove categories
- Test validation: ensure required fields are validated
- Test navigation: verify redirect after successful creation

Example test pattern:
```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { expect, test, vi } from 'vitest';
import { TestSetForm } from './TestSetForm';

// Mock the router
vi.mock('next/navigation', () => ({
  useRouter: () => ({
    push: vi.fn(),
    back: vi.fn(),
  }),
}));

// Mock the store
vi.mock('@/stores/useTestSetStore', () => ({
  useTestSetStore: () => ({
    createTestSet: vi.fn().mockResolvedValue({ id: '123' }),
  }),
}));
```

### Next.js 15.4.6 & React 19 Important Notes

#### Client Components
[Source: Next.js 15.4.6 documentation via Context7]
- **ALWAYS add `'use client'` directive** at the very top of files that use hooks, state, or browser APIs
- Place before any imports to ensure proper client-side rendering
- All components that use form state, hooks like `useState`, `useEffect`, or Next.js navigation hooks MUST be Client Components

#### Form Handling with React 19
[Source: Next.js 15.4.6 documentation via Context7]
- **useActionState Hook**: React 19 replaces `useFormState` with `useActionState`
  - Provides `[state, formAction, pending]` tuple
  - The `pending` boolean is built-in for loading states
  - Example for form with server action:
```typescript
'use client'

import { useActionState } from 'react'
import { createTestSet } from '@/app/actions'

const initialState = {
  message: '',
  errors: {}
}

export function TestSetForm() {
  const [state, formAction, pending] = useActionState(createTestSet, initialState)

  return (
    <form action={formAction}>
      {/* form fields */}
      {state?.message && <p aria-live="polite">{state.message}</p>}
      <button disabled={pending}>
        {pending ? 'Creating...' : 'Create Test Set'}
      </button>
    </form>
  )
}
```

#### Navigation Hooks (App Router)
[Source: Next.js 15.4.6 documentation via Context7]
- Import from `'next/navigation'` (NOT 'next/router'):
```typescript
'use client'

import { useRouter, usePathname, useSearchParams } from 'next/navigation'

export default function TestSetForm() {
  const router = useRouter()
  const pathname = usePathname()
  const searchParams = useSearchParams()
  
  // Programmatic navigation after form submission
  const handleSuccess = () => {
    router.push('/test-sets')
  }
}
```

#### Next.js Form Component
[Source: Next.js 15.4.6 documentation via Context7]
- Use `import Form from 'next/form'` for enhanced form handling
- Supports both string actions (navigation) and function actions (Server Actions)
- With string action, provides built-in prefetching and client-side navigation:
```typescript
import Form from 'next/form'

export default function SearchForm() {
  return (
    <Form action="/search">
      <input name="query" />
      <button type="submit">Search</button>
    </Form>
  )
}
```

#### Dynamic Imports for Client-Only Components
[Source: Next.js 15.4.6 documentation via Context7]
- Use `next/dynamic` with `ssr: false` for components that should only render on client:
```typescript
'use client'

import dynamic from 'next/dynamic'

const CategoryListEditor = dynamic(
  () => import('./CategoryListEditor'),
  { ssr: false }
)
```

#### React 19 Form Status Hook
[Source: Next.js 15.4.6 documentation via Context7]
- `useFormStatus` now provides additional properties in React 19:
```typescript
'use client'

import { useFormStatus } from 'react-dom'

export function SubmitButton() {
  const { pending, data, method, action } = useFormStatus()
  
  return (
    <button disabled={pending} type="submit">
      {pending ? 'Saving...' : 'Save'}
    </button>
  )
}
```

#### Async Components and Promises
[Source: Next.js 15.4.6 documentation via Context7]
- Client Components cannot be async
- Use React's `use` hook to unwrap promises in Client Components:
```typescript
'use client'

import { use } from 'react'

export default function Page({
  params,
  searchParams,
}: {
  params: Promise<{ id: string }>
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>
}) {
  const { id } = use(params)
  const { query } = use(searchParams)
  // ... rest of component
}
```

#### Key Reminders
1. **Client Component Required**: Any component using hooks, state, or form handling MUST have `'use client'` directive
2. **Navigation**: Always use `next/navigation` hooks in App Router, not `next/router`
3. **Form Actions**: Can use Server Actions directly with forms or `useActionState` for enhanced state management
4. **Testing**: Mock `next/navigation` hooks when testing Client Components
5. **Performance**: Keep `'use client'` directive as low in the component tree as possible to minimize client bundle

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-19 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude-opus-4-1-20250805

### Debug Log References
- Fixed missing UI components (textarea, toast)
- Resolved TypeScript type issues with TestSet interface
- Added lucide-react and @radix-ui/react-icons dependencies
- Implemented comprehensive integration tests
- Fixed integration test failures with getAllByPlaceholderText for multiple elements

### Completion Notes List
- All acceptance criteria met
- Form validation implemented with custom validation logic
- Dynamic category list editor with add/remove functionality
- Proper error handling and user feedback via toast notifications
- Transaction-like behavior in service for atomic operations
- Comprehensive test coverage including unit and integration tests
- Fixed test issues identified by QA review

### File List
- apps/web/src/app/test-sets/new/page.tsx (Created)
- apps/web/src/components/features/test-sets/TestSetForm.tsx (Created)
- apps/web/src/components/features/test-sets/CategoryListEditor.tsx (Created)
- apps/web/src/services/testSetService.ts (Modified)
- apps/web/src/stores/useTestSetStore.ts (Modified)
- apps/web/src/components/ui/textarea.tsx (Created)
- apps/web/src/hooks/use-toast.ts (Created via shadcn)
- apps/web/src/components/ui/toast.tsx (Created via shadcn)
- apps/web/src/components/ui/toaster.tsx (Created via shadcn)
- apps/web/src/app/layout.tsx (Modified - added Toaster)
- apps/web/src/components/features/test-sets/TestSetForm.test.tsx (Created)
- apps/web/src/components/features/test-sets/CategoryListEditor.test.tsx (Created)
- apps/web/src/app/test-sets/new/page.integration.test.tsx (Created, Modified - fixed test selectors)

## QA Results

### Review Date: 2025-08-19

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

Overall implementation is solid with clean component architecture following React best practices. The form properly uses client components with 'use client' directive, implements comprehensive validation, and follows the project's established patterns. The dynamic category list editor is well-implemented with proper state management. Service layer correctly implements transaction-like behavior for atomic operations.

### Refactoring Performed

No refactoring needed - code quality is high and follows established patterns well.

### Compliance Check

- Coding Standards: ✓ All standards met - proper TypeScript usage, consistent naming conventions
- Project Structure: ✓ Files correctly placed according to architecture docs
- Testing Strategy: ✓ Comprehensive test coverage with unit and integration tests
- All ACs Met: ✓ All 7 acceptance criteria fully implemented

### Improvements Checklist

- [x] Fix integration test failures - tests use getByPlaceholderText which finds multiple elements since form initializes with one category by default. Use getAllByPlaceholderText or more specific queries
- [ ] Consider adding error boundary for better error handling at page level
- [ ] Add loading skeleton while form initializes
- [ ] Consider memoizing category validation logic for performance with many categories

### Security Review

No security concerns found. Authentication properly enforced, user_id correctly captured from authenticated session, proper input validation on both client and server.

### Performance Considerations

Form performs well with reasonable number of categories. For edge cases with 50+ categories, consider virtualization or pagination of the category list.

### Browser Testing with Playwright MCP

Successfully tested UI navigation and authentication flow:
- ✓ Page routes correctly to /test-sets/new
- ✓ Authentication redirect works properly for protected route
- ✓ Form structure renders correctly with all required fields
- ✓ Development server stable on port 3000/3001

### Final Status

✗ Changes Required - See unchecked items above (primarily test fixes needed)

---

## FINAL REVIEW - 2025-08-19 (After Fixes)

### Reviewed By: Quinn (Senior Developer QA)

### Test Fix Verification

✅ **All requested test fixes have been properly implemented:**
- Integration tests now correctly use `getAllByPlaceholderText` for category inputs
- Button selectors updated to use `getAllByRole` to handle multiple instances
- All 11 tests for Story 2.2 components passing successfully

### Final Test Results
```
✓ TestSetForm.test.tsx - 7 tests passing
✓ page.integration.test.tsx - 4 tests passing
```

### Remaining Improvements (Non-blocking)

The following improvements are suggestions for future enhancement and do not block story completion:
- Consider adding error boundary for better error handling at page level
- Add loading skeleton while form initializes  
- Consider memoizing category validation logic for performance with many categories

### Final Approval Status

✅ **APPROVED - Ready for Done**

All acceptance criteria met, tests passing, code quality excellent. The test issues have been successfully resolved and the implementation is ready for production.