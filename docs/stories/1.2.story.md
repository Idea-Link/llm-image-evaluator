# Story 1.2: Database Schema Migration (Revised)

## Status
Ready for Review

## Story
**As a** developer,
**I want** to create and apply the initial database schema using Supabase migrations,
**so that** the database tables are ready for the application logic.

## Acceptance Criteria
1. The local Supabase environment is running via Docker (`supabase start`).
2. A new SQL migration file is created in `packages/supabase/migrations`.
3. This file contains the complete SQL DDL for the `test_sets`, `ground_truth_categories`, `evaluations`, and `evaluation_results` tables as defined in the architecture document.
4. The `supabase db reset` command successfully applies the migration to the local database, creating all the tables.

## Tasks / Subtasks
- [x] Start local Supabase environment (AC: 1)
  - [x] Navigate to `packages/supabase` directory
  - [x] Run `supabase start` to launch Docker containers
  - [x] Verify PostgreSQL and Supabase services are running
  - [x] Note the local database URL and credentials for verification

- [x] Create migration file for database schema (AC: 2)
  - [x] Use `supabase migration new` command to create a new migration file
  - [x] Name the migration descriptively (e.g., "initial_schema" or "create_core_tables")
  - [x] Verify migration file is created in `packages/supabase/migrations` directory

- [x] Implement complete database schema (AC: 3)
  - [x] Add UUID extension: `CREATE EXTENSION IF NOT EXISTS "uuid-ossp"`
  - [x] Create `test_sets` table with all columns and constraints
  - [x] Create `ground_truth_categories` table with foreign key to test_sets
  - [x] Create `evaluations` table with status check constraint
  - [x] Create `evaluation_results` table with cascade delete
  - [x] Add all required indexes for performance optimization

- [x] Apply migration to local database (AC: 4)
  - [x] Run `supabase db reset` to apply the migration
  - [x] Verify all four tables are created successfully
  - [x] Check that all constraints and indexes are properly applied
  - [x] Test foreign key relationships are working correctly

- [x] Add unit tests for schema validation
  - [x] Create test file `packages/supabase/tests/schema.test.ts`
  - [x] Test that all tables exist with correct columns
  - [x] Verify foreign key constraints are enforced
  - [x] Test that check constraints work as expected

## Dev Notes

### Previous Story Insights
From Story 1.1 completion:
- Supabase package successfully initialized at `packages/supabase`
- Migrations directory already exists at `packages/supabase/migrations`
- Supabase CLI is installed and configured in the package
- Package.json for supabase package is already set up

### Database Technology Stack
[Source: architecture/tech-stack.md]
- **Database**: PostgreSQL 16.x (via Supabase)
- **Provider**: Supabase - managed PostgreSQL with backend services
- **Authentication**: Supabase Auth with Row Level Security (RLS) support

### Complete Database Schema
[Source: architecture/database-schema.md]

#### UUID Extension Required
```sql
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
```

#### Table 1: test_sets
```sql
CREATE TABLE public.test_sets (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    name TEXT NOT NULL,
    description TEXT,
    json_extraction_key TEXT
);

CREATE INDEX ON public.test_sets (user_id);
```

#### Table 2: ground_truth_categories
```sql
CREATE TABLE public.ground_truth_categories (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    test_set_id UUID REFERENCES public.test_sets(id) ON DELETE CASCADE NOT NULL,
    name TEXT NOT NULL,
    description TEXT NOT NULL
);

CREATE INDEX ON public.ground_truth_categories (test_set_id);
```

#### Table 3: evaluations
```sql
CREATE TABLE public.evaluations (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    name TEXT NOT NULL,
    status TEXT NOT NULL DEFAULT 'queued' CHECK (status IN ('queued', 'in_progress', 'completed', 'failed')),
    system_prompt TEXT NOT NULL,
    model_used TEXT NOT NULL,
    test_set_id UUID REFERENCES public.test_sets(id) ON DELETE RESTRICT NOT NULL,
    accuracy_score NUMERIC(5, 2)
);

CREATE INDEX ON public.evaluations (user_id);
CREATE INDEX ON public.evaluations (test_set_id);
```

#### Table 4: evaluation_results
```sql
CREATE TABLE public.evaluation_results (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    evaluation_id UUID REFERENCES public.evaluations(id) ON DELETE CASCADE NOT NULL,
    input_data TEXT, -- URL to image in Supabase Storage
    ground_truth_category TEXT NOT NULL,
    llm_output TEXT,
    is_match BOOLEAN NOT NULL
);

CREATE INDEX ON public.evaluation_results (evaluation_id);
```

### Table Relationships
[Source: architecture/database-schema.md]
- **test_sets** ← **ground_truth_categories** (One-to-Many via test_set_id)
- **test_sets** ← **evaluations** (One-to-Many via test_set_id)
- **evaluations** ← **evaluation_results** (One-to-Many via evaluation_id)
- **auth.users** ← **test_sets** (One-to-Many via user_id)
- **auth.users** ← **evaluations** (One-to-Many via user_id)

### Important Constraints
[Source: architecture/database-schema.md]
- **DELETE CASCADE**: Used for user_id references - deleting a user removes their data
- **DELETE CASCADE**: Used for evaluation_results - deleting an evaluation removes its results
- **DELETE RESTRICT**: Used for test_set_id in evaluations - prevents deletion of Test Sets that are in use
- **Check Constraint**: Status field in evaluations table limited to: 'queued', 'in_progress', 'completed', 'failed'

### File Locations
[Source: architecture/unified-project-structure.md]
- Migration files: `packages/supabase/migrations/`
- Supabase config: `packages/supabase/supabase/config.toml`
- Test files: `packages/supabase/tests/` (create if doesn't exist)

### Coding Standards
[Source: architecture/coding-standards.md]
- Database tables use `snake_case` naming convention
- All database operations must include proper error handling
- No direct database access outside of dedicated data-access layer

### Testing

[Source: architecture/testing-strategy.md]

Testing requirements for this story:
- **Framework**: Vitest (already configured in root)
- **Test Location**: Create tests in `packages/supabase/tests/schema.test.ts`
- **Testing Approach**: 
  - Use Supabase client to verify schema after migration
  - Mock Supabase client for unit tests if needed
  - Test foreign key constraints work correctly
  - Verify check constraints are enforced
  
Example test structure:
```typescript
import { createClient } from '@supabase/supabase-js';
import { describe, it, expect } from 'vitest';

describe('Database Schema', () => {
  it('should have all required tables', async () => {
    // Test implementation
  });
  
  it('should enforce foreign key constraints', async () => {
    // Test implementation
  });
});
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-16 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-08-16 | 1.1 | Implemented QA recommendations | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1

### Debug Log References
- Successfully started local Supabase environment with Docker containers
- Created migration file 20250816205122_initial_schema.sql
- Applied database migration successfully after placing in correct supabase/migrations directory
- All schema validation tests passing
- Updated Supabase CLI from v2.19.7 to v2.34.3
- Created seed.sql file with test data for all tables
- Fixed seed file foreign key constraints and RETURNING clause issues
- Seed data successfully applied with 2 test sets, 8 categories, 3 evaluations, and 11 results

### Completion Notes List
- Initial migration file was created in wrong directory (migrations/ instead of supabase/migrations/), corrected during implementation
- Used context7 MCP for Supabase CLI documentation reference
- All four tables created with proper constraints and indexes
- Foreign key relationships validated through tests
- Check constraints on status field confirmed working
- QA recommendations implemented:
  - Supabase CLI updated from v2.19.7 to v2.34.3 (latest version)
  - Created comprehensive seed.sql file with test data for all tables
  - Seed file includes test user creation in auth.users to satisfy foreign key constraints
  - All tests passing after updates (11 vitest tests, schema verification successful)

### File List
- packages/supabase/supabase/migrations/20250816205122_initial_schema.sql (created)
- packages/supabase/supabase/seed.sql (created)
- packages/supabase/tests/schema.test.ts (created)
- packages/supabase/tests/setup.ts (created)
- packages/supabase/tests/verify-schema.js (created)
- packages/supabase/vitest.config.ts (created)

## QA Results

### Review Date: 2025-08-16
**Reviewer:** Quinn (Senior Developer & QA Architect) 🧪
**Status:** ✅ PASSED WITH OBSERVATIONS

### Folder Structure Review
**Finding:** The migration folder structure is **CORRECT** and follows Supabase best practices.
- ✅ Migration correctly placed at: `packages/supabase/supabase/migrations/20250816205122_initial_schema.sql`
- ✅ No excessive nesting detected - this is the standard Supabase structure
- ✅ Path follows pattern: `packages/[package-name]/supabase/migrations/[timestamp]_[name].sql`

**Note on Structure:** The `supabase/migrations/` nested path within the package is intentional and required by Supabase CLI. This is NOT excessive nesting but the expected convention.

### Schema Implementation Quality
**Database Migration (20250816205122_initial_schema.sql):**
- ✅ All four tables created with correct column definitions
- ✅ UUID extension properly enabled
- ✅ Primary keys using UUID with auto-generation
- ✅ Foreign key constraints properly defined with correct CASCADE/RESTRICT behavior
- ✅ Check constraint on evaluations.status correctly enforced
- ✅ All required indexes created for performance
- ✅ Follows snake_case naming convention per coding standards

### Test Coverage Assessment
**Schema Tests (schema.test.ts):**
- ✅ Comprehensive test suite with 11 passing tests
- ✅ Table existence verification for all four tables
- ✅ Check constraint validation (both valid and invalid values)
- ✅ Foreign key constraint enforcement tests
- ✅ Default value and auto-generated field verification
- ✅ Tests successfully connect to local Supabase instance

### Environment Verification
- ✅ Local Supabase environment running correctly via Docker
- ✅ Database accessible at postgresql://postgres:postgres@127.0.0.1:54322/postgres
- ✅ All services operational (API, GraphQL, Storage, Database)
- ⚠️ Minor: Supabase CLI version outdated (v1.226.4 vs v2.34.3 available) - recommend update

### Code Quality Observations
**Strengths:**
1. Clean, well-structured SQL with proper comments
2. Defensive foreign key strategy (CASCADE vs RESTRICT appropriately used)
3. Performance-conscious with proper indexing
4. Comprehensive test coverage including edge cases
5. Correct implementation matching architecture specifications exactly

**Minor Recommendations:**
1. Consider adding a seed file for test data (warning: "no seed files matched pattern")
2. Update Supabase CLI to latest version for security and feature improvements

### Acceptance Criteria Verification
| AC # | Description | Status |
|------|-------------|--------|
| 1 | Local Supabase environment running via Docker | ✅ Verified |
| 2 | Migration file created in packages/supabase/migrations | ✅ Correct location |
| 3 | SQL DDL for all four tables as per architecture | ✅ Fully implemented |
| 4 | supabase db reset successfully applies migration | ✅ Tests confirm |

### Final Assessment
The implementation is **production-ready** with excellent adherence to specifications and best practices. The concern about excessive nesting in migrations folder is unfounded - the structure follows Supabase conventions correctly. The developer has done an exemplary job with both implementation and testing.

### Second Review Date: 2025-08-17
**Reviewer:** Quinn (Senior Developer & QA Architect) 🧪
**Review Type:** Post-Implementation Verification
**Status:** ✅ VERIFIED - ALL CHANGES CORRECT

### Implementation Verification
**Migration File (20250816205122_initial_schema.sql):**
- ✅ Schema implementation matches specification exactly
- ✅ All table definitions correct with proper data types
- ✅ UUID extension properly enabled at the beginning
- ✅ Foreign key constraints correctly implemented:
  - `auth.users` → `test_sets` (CASCADE DELETE)
  - `auth.users` → `evaluations` (CASCADE DELETE) 
  - `test_sets` → `ground_truth_categories` (CASCADE DELETE)
  - `test_sets` → `evaluations` (RESTRICT DELETE - prevents deletion of in-use test sets)
  - `evaluations` → `evaluation_results` (CASCADE DELETE)
- ✅ Check constraint on `evaluations.status` properly enforced
- ✅ All performance indexes created

### Seed Data Quality
**Seed File (seed.sql):**
- ✅ Comprehensive test data covering all tables
- ✅ Properly handles auth.users dependency with test user creation
- ✅ Uses transactions (DO block) for data consistency
- ✅ Includes diverse evaluation states (completed, in_progress, queued)
- ✅ Realistic test scenarios with both matching and non-matching results
- ✅ Proper use of RETURNING clauses to maintain referential integrity

### Test Suite Verification
**Test Results:**
- ✅ All 11 tests passing successfully
- ✅ Test coverage includes:
  - Table existence verification
  - Column structure validation
  - Foreign key constraint enforcement
  - Check constraint validation
  - Default value generation
- ✅ Tests run in ~518ms - good performance

### Code Quality Assessment
**Exceptional Practices Observed:**
1. **Defensive Programming**: Used ON CONFLICT DO NOTHING for auth user creation
2. **Transaction Safety**: Wrapped seed data in DO block for atomicity
3. **Clear Documentation**: Well-commented SQL with section headers
4. **Performance Conscious**: Appropriate indexing on all foreign keys
5. **Test Data Quality**: Realistic scenarios including edge cases (false matches)

### Minor Observation
- Deprecation warning for CJS Vite Node API - not critical but consider updating Vite configuration in future

### Final Verdict
The implementation is **CORRECT AND COMPLETE**. All changes properly implement the database schema migration as specified in the story requirements. The developer has exceeded expectations by:
1. Adding comprehensive seed data for testing
2. Implementing robust test coverage
3. Following all architectural specifications precisely
4. Maintaining clean, well-documented code

No corrections or improvements needed. Ready for production deployment.